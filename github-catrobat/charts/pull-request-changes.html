<div class="page"></div>
<script>
    menu.registerMenu('Pull Request Changes', '#link-chart-pull-request-changes', function() {
        var chartElement = addChartTemplate();
        chartElement.querySelector('.chart').height = 8000;
        $.getCachedJSON('./charts/output/pull-request-changes.json').then(function(data) {
            var chartData = combineKeys(data);
            var maxChanges = Math.max.apply(null, chartData.changes);
            var chart = createChart(chartElement.querySelector('.chart'), {
                type: 'horizontalBar',
                data: {
                    labels: chartData.number,
                    datasets: [{
                        label: 'Additions',
                        data: chartData.additions,
                        backgroundColor: colors.addition
                    }, {
                        label: 'Deletions',
                        data: chartData.deletions,
                        backgroundColor: colors.deletion
                    }]
                },
                options: {
                    tooltips: {enabled: false},
                    scales: {
                        xAxes: [{
                            position: 'top',
                            stacked: true,
                            ticks: {
                                beginAtZero: true,
                                max: Math.ceil(chartData.changes[0] / 1000) * 1000
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Changes'
                            }
                        }],
                        yAxes: [{
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '#' + value;
                                }
                            }
                        }]
                    },
                }
            });
            createSlider(chartElement.querySelector('.x-slider-top'), {
                range: false,
                scale: 'logarithmic',
                min: 0,
                max: maxChanges,
                value: maxChanges
            }).on("slide", updateXAxes(chart))
                    .on("slide", function(value) {
                        const isInRange = (v) => v <= value;

                        const newLabels = [];
                        const newAdditions = [];
                        const newDeletions = [];
                        for (let i = 0; i < chartData.additions.length; i++) {
                            if (isInRange(chartData.additions[i] + chartData.deletions[i])) {
                                newLabels.push(chartData.number[i]);
                                newAdditions.push(chartData.additions[i]);
                                newDeletions.push(chartData.deletions[i]);
                            }
                        }
                        chart.data.labels = newLabels;
                        chart.data.datasets[0].data = newAdditions;
                        chart.data.datasets[1].data = newDeletions;
                        chart.update();
                    });
        });
    });
</script>
